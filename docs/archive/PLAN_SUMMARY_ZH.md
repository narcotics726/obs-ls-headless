# 项目规划与实施总结（至今）

本文件总结当前项目状态、部署与运维实践、已完成的基础能力，以及围绕“备份（assembled）”与“AI 分析（RAG）”的下一阶段实现计划。文档不包含代码示例与具体供应商信息。

## 1. 当前状态
- 核心能力：
  - 同步并组装来自后端文档库的笔记（含分块与加密内容的正确处理）。
  - 提供 REST API 查询与管理能力。
  - 运行时将状态与数据分别持久化到挂载目录：`/state`（状态）与`/data`（笔记）。
- 运行环境：
  - Node LTS（24.x），ESM 模式。
  - 多阶段容器镜像构建；运行镜像仅包含生产依赖与构建产物。
- 部署与网络：
  - 使用容器编排启动服务；通过反向代理暴露对外服务并启用基础身份认证。
  - 所有 API 统一前缀：`/api`。

## 2. 部署与运维（当前做法）
- 容器镜像：
  - 多阶段构建（安装依赖→编译→裁剪依赖→仅携带运行时内容）。
  - 进程以最小权限运行的原则进行配置（后续可进一步加固）。
- 运行参数：
  - 通过环境变量配置服务端口、主机、文档库连接、同步间隔等。
  - 数据卷：
    - `/state`：保存同步进度、索引、内部状态。
    - `/data`：保存组装后的笔记与相关生成内容。
- 访问控制：
  - 建议在反向代理处启用基础身份认证（Basic Auth），再反代到后端服务。
  - 可根据需要收窄 CORS 与来源地址。
- 健康检查与日志：
  - 暴露健康检查端点；日志以结构化格式输出，便于集中收集与分析。

## 3. CI/CD（当前做法）
- 提供手动触发的构建流程：
  - 拉取代码、安装依赖、执行测试、构建容器镜像、推送到镜像仓库。
  - 使用缓存加速构建；按需生成可追踪的镜像标签。

## 4. API 调整（已完成）
- 全部路由增加统一前缀 `/api`，以便日后引入版本化（如 `/api/v1`）。

## 5. 备份方案（优先实现，备份 assembled）
- 目标：
  - 在笔记发生新增/修改/删除后，进行增量化备份；同时提供手动全量触发能力。
  - 备份对象为“组装且解密后的成品文件”（Markdown/二进制），便于直接恢复与使用。
- 配置建议：
  - 基本连接与鉴权参数。
  - 可选项：路径风格、是否使用 TLS、对象存储端加密策略、备份路径前缀、是否启用备份。
- 命名与去重：
  - 备份键名以“备份前缀/库名/笔记路径”命名。
  - 对内容计算摘要，未变化则跳过上传；在 `/state` 维护备份索引以加速判断。
- 触发与流程：
  - 同步流程完成后将变更笔记入队；后台批处理上传（限流与重试）。
  - 提供查询备份状态与手动触发接口（全量/增量）。
- 安全与合规：
  - 因备份的是明文成品，建议启用对象存储端加密；必要时可在客户端侧追加加密流程（可选后续）。
- 恢复：
  - 从对象存储按键名组织拉回到 `/data` 对应目录结构即可恢复。

## 6. AI 分析（最小闭环：检索 + 生成）
- 目标：
  - 提供基于检索增强的问答与搜索能力（RAG）。
  - 在不确定具体模型前提下，先走通“嵌入 + 对话”的调用链路。
- 能力组件：
  - 文本分块：对 Markdown 进行预处理与切块（设定大小与重叠），生成可索引的片段。
  - 嵌入：为片段计算向量表示，并持久化本地索引（优先存储到 `/data`）。
  - 检索：在本地向量库中进行相似度查询，结合关键词检索作为候选召回的补充（可选）。
  - 生成：将检索到的片段作为上下文，进行答案生成与摘要。
- 工作流：
  - 初次全量索引：分批构建向量库；之后对增量变更实时更新索引。
  - 低并发与重试控制，避免资源尖峰；错误与超时有明确分级与记录。
- 接口规划（概要）：
  - 触发或重建索引、查询相似片段、提出问题获得回答与引用。
- 资源与规模：
  - 对于个人笔记的规模，线性检索或轻量索引结构即可满足；本地仅维护向量与元数据，资源可控。

## 7. 插件化设计（解耦备份与 AI）
- 目标：
  - 将“备份”“AI 分析”设计为可插拔插件，减少对核心的侵入，支持按需启用/禁用。
- 插件契约（概念）：
  - 提供 `setup/start/stop` 生命周期；插件在 `setup` 中注册事件监听与路由、读取自身配置。
  - 插件上下文包括：服务实例、日志句柄、全局配置、事件总线、受限的核心服务访问与路由注册能力。
- 跨进程支持（预留）：
  - 插件可以以独立进程运行，通过 stdin/stdout 的 JSON-RPC 协议交互；主进程负责生命周期管理、超时/重试/错误隔离。
  - 语言无关，便于用 Rust 等实现插件；后续可扩展鉴权、限流与并发控制。
- 事件总线：
  - 核心在关键节点发出事件（如 `sync:start/end`、`note:upsert/delete`）；插件订阅并处理。
- 加载与隔离：
  - 插件由“插件管理器”按配置动态加载；每个插件有独立日志上下文与错误隔离，不影响主流程。
- 路由注册：
  - 插件以统一前缀（如 `/api/backup/*`、`/api/ai/*`）注册自身 API，避免与核心冲突。

## 8. 实施里程碑（建议）
- 基础设施与插件化：
  - 事件总线实现；
  - 完成插件化设计，重构现有代码以支持插件加载与隔离。
  - 实现备份与 AI 插件的基本框架（空壳）。
  - 增加 /state 的 schema 版本管理（增加版本字段即可）。
- 备份（assembled）：
  - 新增备份服务与配置占位；
  - 打通增量与手动触发；
  - 状态查询；
  - 去重、限流、重试（可选）
- AI（最小 RAG）：
  - 新增 AI Provider 协议与本地索引；实现切块、嵌入缓存、线性相似度检索、基于上下文的回答。
- 强化与优化：
  - 索引结构升级（按需）；完善缓存策略、异常恢复、指标与追踪。
- 安全与可靠性：
  - 容器加固、访问控制细化、速率限制、审计日志、备份与 AI 的可观测性完善。

## 9. 风险与注意事项
- 隐私与安全：
  - 备份为明文成品，需确保传输与存储加密、访问控制与凭据管理到位。
- 资源与配额：
  - 嵌入与生成应设置并发与速率上限，避免消耗过快或触发限流。
- 数据一致性：
  - 同步、备份与索引之间的状态需要对齐与校验，避免“已删除/未更新”的悬挂状态。
- 失败与重试：
  - 明确重试策略与终止条件，保留失败样本，支持人工介入与重放。

## 10. 待确认项
- 备份：
  - 备份前缀命名、是否开启对象存储端加密、并发与批次默认值。
- AI：
  - 检索 Top-K、分块大小与重叠、是否启用混合检索（关键词 + 向量）。
